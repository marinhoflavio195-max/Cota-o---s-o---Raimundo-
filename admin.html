<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - S√£o Raimundo Supermercado</title>

<style>
body{
  margin:0;
  font-family:Arial, Helvetica, sans-serif;
  background:#f4f4f4;
}

header{
  background:#B22222;
  color:white;
  padding:20px;
  text-align:center;
  font-size:22px;
  font-weight:bold;
}

.container{
  padding:20px;
}

.card{
  background:white;
  padding:15px;
  margin-bottom:15px;
  border-radius:10px;
  box-shadow:0 0 10px rgba(0,0,0,0.1);
}

button{
  background:#ff0000;
  color:white;
  padding:8px 15px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  margin:5px 0;
}

button:hover{
  background:#cc0000;
}

.resultado{
  background:#fff;
  margin-top:10px;
  padding:10px;
  border-radius:8px;
  font-size:14px;
}
</style>
</head>

<body>

<header>
S√£o Raimundo Supermercado - ADMIN
<button onclick="logout()" style="float:right;">Sair</button>
</header>

<div class="container">
<h2>Cota√ß√µes</h2>
<div id="lista"></div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { 
  getAuth,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import { 
  getFirestore, 
  collection, 
  getDocs
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCeJtoTDcNmA8aMLtRrHR-CoZUQkbe5TYk",
  authDomain: "cot-online-sao-raimundo-sup.firebaseapp.com",
  projectId: "cot-online-sao-raimundo-sup",
  storageBucket: "cot-online-sao-raimundo-sup.firebasestorage.app",
  messagingSenderId: "57432026650",
  appId: "1:57432026650:web:8a47dd3f22b40bd6e02ba3"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const lista = document.getElementById("lista");


// üîí PROTE√á√ÉO DE ACESSO
onAuthStateChanged(auth, (user) => {
  if (user) {
    if (user.email !== "admin@saoraymundo.com") {
      alert("Acesso permitido apenas para administrador.");
      window.location.href = "fornecedor.html";
    }
  } else {
    window.location.href = "index.html";
  }
});


// üö™ LOGOUT
window.logout = function(){
  signOut(auth).then(() => {
    window.location.href = "index.html";
  });
};


// üìã LISTAR COTA√á√ïES + MENOR PRE√áO
async function carregarCotacoes(){

  lista.innerHTML = "";

  const cotacoesSnap = await getDocs(collection(db,"cotacoes"));

  cotacoesSnap.forEach(async (cotDoc) => {

    const cotacaoId = cotDoc.id;
    const cotData = cotDoc.data();

    let html = `
      <div class="card">
        <h3>${cotData.nome}</h3>
        <button onclick="verMenorPreco('${cotacaoId}')">Ver Menor Pre√ßo</button>
        <div id="resultado-${cotacaoId}" class="resultado"></div>
      </div>
    `;

    lista.innerHTML += html;

  });

}

window.verMenorPreco = async function(cotacaoId){

  const respostasSnap = await getDocs(collection(db,"cotacoes",cotacaoId,"respostas"));

  let menores = {};

  respostasSnap.forEach((resDoc)=>{

    const dados = resDoc.data();
    const fornecedor = dados.fornecedor;
    const produtos = dados.produtos;

    for(let nomeProduto in produtos){

      let preco = parseFloat(produtos[nomeProduto]);

      if(!menores[nomeProduto] || preco < menores[nomeProduto].preco){
        menores[nomeProduto] = {
          fornecedor: fornecedor,
          preco: preco
        };
      }

    }

  });

  let resultadoHTML = "<b>üèÜ Menores Pre√ßos:</b><br><br>";

  for(let produto in menores){
    resultadoHTML += `
      ${produto}<br>
      ‚úÖ ${menores[produto].fornecedor} - R$ ${menores[produto].preco.toFixed(2)}<br><br>
    `;
  }

  document.getElementById("resultado-"+cotacaoId).innerHTML = resultadoHTML;

}

carregarCotacoes();

</script>

</body>
</html>
